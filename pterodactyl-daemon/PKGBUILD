# Maintainer: Moses Narrow <moe_narrow@use.startmail.com>
# Contributor: 2xsaiko <aur@dblsaiko.net>
projectname=pterodactyl
pkgname=pterodactyl-daemon
pkgname1=daemon
githuborg=pterodactyl
pkgdesc="Open-source server control and management daemon for pterodactyl-panel."
pkgver=0.6.12
pkgpath="github.com/${githuborg}/${pkgname1}"
pkgrel=5
arch=('any')
url="https://${pkgpath}"
license=()
makedepends=()
# https://pterodactyl.io/community/installation-guides/daemon/debian10.html#server-configuration
depends=(docker nodejs npm python)
source=(
  "${url}/releases/download/v${pkgver}/${pkgname1}.tar.gz"
  'pterodactyl-daemon.sh'
  'pterodactyl-daemon-config.sh'
  'wings.service'
)
sha256sums=(
  'aef507f4b9f1272b678cf8b23c0cf0db58d1bba4e8a02d6744018f63db4ff66a'
  '9f10ed372aa45c6dddc9f3b4abe5c93f68efe447d0debe5bc2a2c07588c7c143'
  '3252d01e103bc7c28d541308fdeeee1ab9eb9654017b976e84b22081c397c460'
  'abf8d521550a79e6a6d7cebe845eb6cb1ba602a8583cb885fc7fd94152b727cb'
)

build() {
	mkdir -p ${srcdir}/npm-cache
	tar -xzf ${srcdir}/${pkgname1}.tar.gz
  cd "${pkgname1}-${pkgver}"
  npm update
	npm install --only=production --user root
}

package() {
	# https://pterodactyl.io/daemon/getting_started.html#download-files
	mkdir -p ${pkgdir}/usr/bin/
	mkdir -p ${pkgdir}/usr/lib/systemd/system/
	mkdir -p ${pkgdir}/srv/${pkgname1}/npm-cache
	mkdir -p ${pkgdir}/srv/${pkgname1}-data
	# See https://github.com/npm/npm/issues/9359 for details.
  cp -r "${srcdir}/${pkgname1}-${pkgver}" "${pkgdir}/srv/${pkgname}"
	find "${pkgdir}"/srv/${pkgname} -type d -exec chmod 755 {} +
	# npm gives ownership of ALL FILES to build user
	chown -R root:root "$pkgdir"
	# https://bugs.archlinux.org/task/63396
	# install scripts & systemd service
  install -Dm755 ${srcdir}/${pkgname}.sh ${pkgdir}/srv/${pkgname}/${pkgname}.sh
	ln -rTsf ${pkgdir}/srv/${pkgname1}/${pkgname}.sh ${pkgdir}/usr/bin/${pkgname}
	install -Dm755 ${srcdir}/${pkgname}-config.sh ${pkgdir}/srv/${pkgname}/${pkgname}-config.sh
	ln -rTsf ${pkgdir}/srv/${pkgname1}/${pkgname}-config.sh ${pkgdir}/usr/bin/${pkgname}-config
	install -Dm644 ${srcdir}/wings.service ${pkgdir}/usr/lib/systemd/system/
}
